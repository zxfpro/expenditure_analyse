## PRD (产品需求文档) - 最终版

### 项目名(包名)规范

`expenditure_analyse`

### 版本号与更新

**初始版本：V1.0**

### 风格

务实风格，承担拉齐各个部分角色的认知。

### 1. 引言

#### 1.1 项目背景与目标
当前市场上的花销管理工具在“定制化”、“自动化”及“AI深度赋能”方面存在明显不足，用户难以100%掌控和修改工具行为，也难以方便地整合大模型进行深层次分析。用户核心诉求是对花销进行全方位分析，从而实现对本月消费的控制和预期，并期待工具能通过花销数据进行深层次的行为分析，提供消费建议与预测。

本项目旨在开发一个高度可定制、自动化且易于与大模型集成的 Python 包，核心目标是：
1.  帮助用户全面掌控每月花销，并通过智能分析提供个性化的消费行为洞察、生活指南和消费预测。
2.  提供开放且可扩展的接口，作为其他工具或应用程序的基础组件，方便集成。

#### 1.2 产品定位
一个面向开发者的 Python 包，提供银行流水解析、结构化、基础消费分析，并为未来与大模型深度集成（行为分析、生活指南、消费预测）预留接口和设计规范。它不是一个独立的应用程序，而是作为其他应用（如命令行工具、Web应用、内部分析脚本等）的基础组件。

### 2. 用户痛点与需求分析

*   **痛点1：** 现有花销工具定制化程度低，无法满足个性化需求。
    *   **需求：** 提供高度灵活和可配置的模块，允许用户修改或扩展分析逻辑。
*   **痛点2：** 数据录入和分析过程自动化程度不足，操作繁琐。
    *   **需求：** V1.0 支持自动化解析银行流水CSV文件，减少手动录入和整理的工作量。
*   **痛点3：** 难以对个人花销有宏观掌控，不清楚钱花在哪里以及如何节流。
    *   **需求：** 提供清晰的月度花销报告，包括总额、分类占比等，帮助用户快速了解消费结构。
*   **痛点4：** 缺乏基于消费数据的深层次行为洞察和个性化建议。
    *   **需求：** V1.0 阶段预留与大模型集成的接口，为未来实现通过大模型进行深层消费习惯分析、生活指南和消费预测提供基础。
*   **痛点5：** 分析结果难以被其他工具复用或进一步处理。
    *   **需求：** 提供标准化的数据结构和开放的Python接口，便于与其他工具或系统集成。

### 3. 核心功能 (MVP V1.0)

#### 3.1 数据输入模块 (`parser`)
*   **功能：** 支持解析标准的银行流水CSV文件。
*   **细节：**
    *   能够读取用户指定的CSV文件路径。
    *   能够根据用户提供的配置（如列名映射、交易类型判断关键词）识别日期、交易金额、交易描述等核心字段。
    *   具备初步的异常数据处理能力（如非数字金额的跳过、日期格式错误的标记）。
    *   **健壮性：** 对文件不存在、权限问题、编码错误、CSV格式错误等情况进行 `try-except` 捕获，并抛出清晰的 `ValueError` 或自定义异常。

#### 3.2 数据结构化与分类模块 (`core`, `classifier`)
*   **功能：** 将解析后的原始流水数据结构化为统一的 `Transaction` 对象，并进行初步的消费分类。
*   **细节：**
    *   定义统一的内部数据模型 `Transaction` 类，包含日期、金额、类型（收入/支出）、类别、描述等属性。
    *   提供基于关键字匹配的**默认消费分类规则**。
    *   支持用户自定义分类规则（通过配置参数传递），并支持规则的优先级或多重匹配。
    *   对未能分类的交易标记为 `Uncategorized`，而非抛出错误。
    *   **健壮性：** 对日期解析失败、金额转换失败等异常数据进行妥善处理（例如，跳过该行并记录日志）。

#### 3.3 核心花销分析模块 (`analyzer`)
*   **功能：** 对结构化后的月度花销数据进行统计和分析。
*   **细节：**
    *   计算当月总收入、总支出、净结余。
    *   计算各消费类别的支出总额及占比。
    *   提供按维度聚合的能力（例如，未来可扩展按日、按周统计）。
    *   输出分析结果为结构化的Python字典。
    *   **健壮性：** 能够处理空交易列表或只包含收入/支出的情况。

#### 3.4 大模型集成预留模块 (`llm_integrator`)
*   **功能：** 作为与外部大模型交互的抽象层，规范数据传输和结果处理的接口。
*   **细节：**
    *   提供 `prepare_data_for_llm(analysis_report: dict) -> dict` 方法，用于将内部分析结果转换为大模型易于理解的输入格式。
    *   提供 `process_llm_response(response_data: dict) -> dict` 方法，用于将大模型返回的原始响应解析为本项目可用的洞察和建议。
    *   **V1.0 阶段，此模块不包含实际的大模型 API 调用逻辑**，而是作为一个**占位符和契约**，预设未来调用方会自行配置和实现与大模型的交互。它的主要作用是规范数据格式。
    *   **健壮性：** 对大模型返回数据格式不符、或为空的情况进行处理，返回默认提示信息。

#### 3.5 开放接口与管理器模块 (`main`)
*   **功能：** 暴露核心功能为用户友好的Python API，并提供一个高级管理器（门面）简化使用流程。
*   **细节：**
    *   提供 `ExpenseAnalysisManager` 类作为门面，封装了 `parser`, `classifier`, `analyzer`, `llm_integrator` 的调用逻辑。
    *   提供 `analyze_bank_statement(file_path: str, config: dict) -> (dict, dict)` 等清晰的入口函数，简化用户的操作。
    *   所有对外接口设计直观，参数命名清晰，返回值结构清晰。

### 4. 非功能性需求

*   **性能：** 能够快速处理常见的银行流水CSV文件（例如，千行以内的数据能在秒级完成解析和基础分析）。
*   **可扩展性：** 模块化设计，接口抽象良好，方便未来添加新的数据源（如PDF、图片OCR）、新的分析维度、新的输出格式，以及替换或增加大模型接口。
*   **易用性：** API接口设计直观，参数命名清晰。提供详细的文档和示例代码。
*   **健壮性：** 系统具备良好的错误处理和容错机制，对异常输入（如文件不存在、格式错误）、数据缺失等情况能稳定运行并给出明确反馈（通过异常抛出或返回默认/空值）。
*   **数据安全与隐私：** 默认采用本地数据处理和存储，不涉及敏感数据上传到云端（除非用户自行配置大模型API调用，且该API由用户负责安全）。
*   **可配置性：** 允许用户通过传入配置字典或加载配置文件来定制解析规则、分类规则等。

### 5. 核心案例 (用例)

#### 5.1 分析上月银行流水
**用例名称：** 分析上月消费
**参与者：** 开发者（使用`expenditure_analyse`包）、银行流水CSV文件
**前置条件：**
1.  已安装`expenditure_analyse`包。
2.  存在一份有效的银行流水CSV文件，包含日期、金额、描述等核心列。
3.  已准备好包含CSV映射和分类规则的配置字典。
**基本流程：**
4.  开发者编写Python脚本，导入`expenditure_analyse.main.ExpenseAnalysisManager`。
5.  实例化`ExpenseAnalysisManager`，传入配置。
6.  调用`manager.analyze_bank_statement()`方法，传入CSV文件路径。
7.  内部流程：
    a.  `CsvParser`读取并解析CSV文件，将原始数据转换为字典列表。
    b.  程序遍历原始数据，对每行数据进行处理，包括日期、金额转换和类型判断。
    c.  `ExpenseClassifier`根据配置的规则对每笔交易进行分类，生成 `Transaction` 对象。
    d.  `ExpenseAnalyzer`对所有 `Transaction` 对象进行月度统计，生成总收入、总支出、类别占比等报告。
    e.  `LlmIntegrator`接收分析报告，将其转换为大模型预期的输入格式（不实际调用大模型）。
8.  方法返回月度花销报告和LLM洞察的模拟或预格式化数据。
9.  开发者在脚本中获取分析结果，并进行后续处理（如打印到控制台、保存到文件或用于其他应用）。
**预期结果：** 开发者获得结构化的月度花销分析数据（Python字典），并获得一个用于大模型洞察的预格式化数据，从而可以在自己的应用中展示、存储或进一步处理。

### 6. 上游和下游基本情况

*   **上游：**
    *   **银行流水CSV文件：** 作为主要的输入数据源，需要解析和适配不同银行可能存在的CSV格式差异（通过配置实现）。
*   **下游：**
    *   **开发者编写的Python应用程序/脚本：** 作为本包的主要调用方，获取和使用分析结果。
    *   **外部大模型API：** 本包的`LlmIntegrator`模块将输出结构化的数据供外部大模型API调用，大模型返回分析结果。本包不包含大模型API的实际调用实现，只负责数据接口和规范。
    *   **其他数据处理/可视化工具：** 分析结果通过Python数据结构（如字典、DataFrame）无缝对接其他数据处理库（如Pandas）或可视化库（如Matplotlib、Seaborn）。

